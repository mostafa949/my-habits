<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø¹Ø§Ø¯Ø§ØªÙŠ</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800;900&display=swap" rel="stylesheet">
    <style>
        :root{
            --bg1:#0f172a;--bg2:#1e293b;--card:rgba(30,41,59,0.85);
            --accent:#10b981;--accent2:#34d399;--accentD:#059669;
            --gold:#f59e0b;--blue:#3b82f6;--purple:#8b5cf6;
            --red:#ef4444;--pink:#ec4899;--cyan:#06b6d4;
            --orange:#f97316;--teal:#14b8a6;--indigo:#6366f1;
            --t1:#f1f5f9;--t2:#94a3b8;--t3:#64748b;
            --brd:rgba(255,255,255,0.08);--brd2:rgba(255,255,255,0.15);
            --r:20px;--r2:12px;--r3:8px;
            --navH:72px;--headH:60px;
            --font:'Tajawal',sans-serif;
        }
        *,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
        html{scroll-behavior:smooth;-webkit-tap-highlight-color:transparent}
        body{font-family:var(--font);background:var(--bg1);color:var(--t1);min-height:100vh;overflow-x:hidden}
        ::-webkit-scrollbar{width:4px}
        ::-webkit-scrollbar-thumb{background:var(--accent);border-radius:10px}
        body::before{
            content:'';position:fixed;top:-50%;left:-50%;width:200%;height:200%;
            background:radial-gradient(circle at 30% 20%,rgba(16,185,129,0.08) 0%,transparent 50%),
            radial-gradient(circle at 70% 80%,rgba(245,158,11,0.06) 0%,transparent 50%);
            animation:bgF 20s ease-in-out infinite;z-index:0;pointer-events:none;
        }
        @keyframes bgF{0%,100%{transform:translate(0,0)}33%{transform:translate(2%,-2%)}66%{transform:translate(-1%,1%)}}

        .header{
            position:fixed;top:0;left:0;right:0;height:var(--headH);
            background:rgba(15,23,42,0.92);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);
            border-bottom:1px solid var(--brd);display:flex;align-items:center;
            justify-content:space-between;padding:0 20px;z-index:100;
        }
        .header-r{display:flex;align-items:center;gap:10px}
        .logo{font-size:28px;animation:pul 2s ease-in-out infinite}
        @keyframes pul{0%,100%{transform:scale(1)}50%{transform:scale(1.12)}}
        .header h1{font-size:20px;font-weight:800;background:linear-gradient(135deg,var(--accent),var(--gold));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
        .header-date{font-size:12px;color:var(--t2)}

        .content{position:relative;z-index:1;padding-top:calc(var(--headH)+10px);padding-bottom:calc(var(--navH)+30px);min-height:100vh}
        .page{display:none;padding:10px 16px 20px;animation:fadeI .4s ease}
        .page.active{display:block}
        @keyframes fadeI{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}

        .greeting{text-align:center;padding:20px 0 10px}
        .greeting-t{font-size:24px;font-weight:300;color:var(--t2);margin-bottom:4px}
        .greeting-s{font-size:28px;font-weight:800;background:linear-gradient(135deg,var(--accent2),var(--accent));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}

        .prog-w{display:flex;justify-content:center;padding:20px 0}
        .prog-r{position:relative;width:200px;height:200px}
        .prog-r svg{transform:rotate(-90deg);width:200px;height:200px}
        .prog-r .bgC{fill:none;stroke:var(--brd);stroke-width:8}
        .prog-r .fgC{fill:none;stroke:url(#g1);stroke-width:8;stroke-linecap:round;transition:stroke-dashoffset 1s cubic-bezier(.4,0,.2,1)}
        .prog-c{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center}
        .prog-p{font-size:42px;font-weight:900;background:linear-gradient(135deg,var(--accent),var(--gold));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;line-height:1}
        .prog-l{font-size:13px;color:var(--t2);margin-top:4px}

        .stats{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin:15px 0}
        .stat{background:var(--card);backdrop-filter:blur(10px);border:1px solid var(--brd);border-radius:var(--r2);padding:16px 10px;text-align:center;transition:.3s}
        .stat:active{transform:scale(.95)}
        .stat-i{font-size:24px;margin-bottom:6px}
        .stat-v{font-size:22px;font-weight:800}
        .stat-l{font-size:11px;color:var(--t2);margin-top:2px}

        .quote{background:linear-gradient(135deg,rgba(16,185,129,0.15),rgba(245,158,11,0.1));border:1px solid rgba(16,185,129,0.2);border-radius:var(--r);padding:20px;margin:15px 0;position:relative;overflow:hidden}
        .quote::before{content:'â';position:absolute;top:-10px;right:10px;font-size:60px;opacity:.1;color:var(--accent)}
        .quote-t{font-size:15px;line-height:1.8;font-weight:500}
        .quote-s{font-size:12px;color:var(--accent);margin-top:10px;font-weight:700}

        .sec{font-size:18px;font-weight:700;margin:20px 0 12px;display:flex;align-items:center;gap:8px}
        .hlist{display:flex;flex-direction:column;gap:12px}

        .hcard{background:var(--card);backdrop-filter:blur(10px);border:1px solid var(--brd);border-radius:var(--r);padding:18px;transition:.3s;position:relative;overflow:hidden}
        .hcard:active{transform:scale(.98)}
        .hbar{position:absolute;top:0;right:0;width:4px;height:100%;border-radius:0 4px 4px 0}
        .hhead{display:flex;align-items:center;justify-content:space-between;margin-bottom:4px}
        .hinfo{display:flex;align-items:center;gap:12px}
        .hemoji{font-size:32px;width:50px;height:50px;display:flex;align-items:center;justify-content:center;border-radius:var(--r2)}
        .hname{font-size:16px;font-weight:700}
        .hstreak{font-size:12px;color:var(--t2);display:flex;align-items:center;gap:4px;margin-top:2px}
        .hstreak .fire{color:#ff6b35}
        .hbadge{font-size:13px;font-weight:700;padding:6px 12px;border-radius:20px;min-width:55px;text-align:center}
        .hacts{display:flex;align-items:center;gap:4px}

        .hsubs{margin-top:14px;padding-top:14px;border-top:1px solid var(--brd);display:flex;flex-direction:column;gap:8px}
        .sub{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;background:rgba(255,255,255,0.03);border-radius:var(--r3);transition:.3s}
        .sub:active{background:rgba(255,255,255,0.08)}
        .sub-n{font-size:15px;font-weight:500}

        .chk{position:relative;width:28px;height:28px;cursor:pointer}
        .chk input{display:none}
        .chk-m{width:28px;height:28px;border-radius:50%;border:2px solid var(--t3);display:flex;align-items:center;justify-content:center;transition:.3s}
        .chk input:checked+.chk-m{border-color:var(--accent);background:var(--accent);animation:ckB .4s cubic-bezier(.4,0,.2,1)}
        .chk input:checked+.chk-m::after{content:'âœ“';color:white;font-weight:700}
        @keyframes ckB{0%{transform:scale(1)}30%{transform:scale(1.3)}60%{transform:scale(.9)}100%{transform:scale(1)}}

        .htog{width:100%;padding:14px;border:2px dashed var(--brd2);border-radius:var(--r2);background:transparent;color:var(--t2);font-family:var(--font);font-size:15px;font-weight:600;cursor:pointer;transition:.3s;margin-top:12px;display:flex;align-items:center;justify-content:center;gap:8px}
        .htog.done{border-style:solid}
        .htog:active{transform:scale(.97)}

        .del{background:none;border:none;color:var(--t3);font-size:18px;cursor:pointer;padding:4px 8px;border-radius:8px;transition:.3s}
        .del:active{color:var(--red);background:rgba(239,68,68,0.1)}

        /* ========== FAB BUTTON ========== */
        .fab{
            position:fixed !important;
            bottom:calc(var(--navH) + 20px) !important;
            left:20px !important;
            width:60px !important;
            height:60px !important;
            border-radius:50% !important;
            background:linear-gradient(135deg,#10b981,#059669) !important;
            color:white !important;
            border:none !important;
            font-size:32px !important;
            font-weight:bold !important;
            display:flex !important;
            align-items:center !important;
            justify-content:center !important;
            cursor:pointer !important;
            box-shadow:0 6px 25px rgba(16,185,129,0.5) !important;
            z-index:99 !important;
            visibility:visible !important;
            opacity:1 !important;
        }
        .fab:active{transform:scale(.9)}

        /* ========== MODAL ========== */
        .modal-bg{position:fixed;inset:0;background:rgba(0,0,0,0.7);backdrop-filter:blur(8px);z-index:200;display:none;align-items:flex-end;justify-content:center}
        .modal-bg.open{display:flex}
        .modal{background:var(--bg2);border-radius:var(--r) var(--r) 0 0;width:100%;max-width:500px;max-height:85vh;overflow-y:auto;padding:24px 20px 40px;animation:slU .4s cubic-bezier(.4,0,.2,1)}
        @keyframes slU{from{transform:translateY(100%)}to{transform:translateY(0)}}
        .modal-h{width:40px;height:4px;background:var(--t3);border-radius:4px;margin:0 auto 20px}
        .modal-t{font-size:22px;font-weight:800;margin-bottom:20px;text-align:center}
        .fg{margin-bottom:18px}
        .fl{font-size:14px;font-weight:600;color:var(--t2);margin-bottom:8px;display:block}
        .fi{width:100%;padding:14px 16px;background:rgba(255,255,255,0.05);border:1px solid var(--brd);border-radius:var(--r2);color:var(--t1);font-family:var(--font);font-size:16px;font-weight:500;transition:.3s;outline:none}
        .fi:focus{border-color:var(--accent);background:rgba(16,185,129,0.05)}
        .fi::placeholder{color:var(--t3)}

        .emG{display:grid;grid-template-columns:repeat(6,1fr);gap:8px}
        .emO{width:100%;aspect-ratio:1;display:flex;align-items:center;justify-content:center;font-size:24px;background:rgba(255,255,255,0.03);border:2px solid transparent;border-radius:var(--r3);cursor:pointer;transition:.3s}
        .emO:active,.emO.sel{border-color:var(--accent);background:rgba(16,185,129,0.1);transform:scale(1.1)}

        .coG{display:flex;gap:10px;flex-wrap:wrap}
        .coO{width:38px;height:38px;border-radius:50%;border:3px solid transparent;cursor:pointer;transition:.3s;position:relative}
        .coO.sel{border-color:white;transform:scale(1.15)}
        .coO.sel::after{content:'âœ“';position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:white;font-weight:700;font-size:14px}

        .sgG{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-bottom:20px}
        .sgB{display:flex;align-items:center;gap:8px;padding:12px;background:rgba(255,255,255,0.03);border:1px solid var(--brd);border-radius:var(--r3);color:var(--t1);font-family:var(--font);font-size:13px;font-weight:500;cursor:pointer;transition:.3s}
        .sgB:active{background:rgba(16,185,129,0.1);border-color:var(--accent)}
        .sgB .se{font-size:20px}

        .btnM{width:100%;padding:16px;background:linear-gradient(135deg,var(--accent),var(--accentD));border:none;border-radius:var(--r2);color:white;font-family:var(--font);font-size:17px;font-weight:700;cursor:pointer;transition:.3s;margin-top:10px}
        .btnM:active{transform:scale(.97);opacity:.9}
        .btnC{width:100%;padding:16px;background:transparent;border:1px solid var(--brd);border-radius:var(--r2);color:var(--t2);font-family:var(--font);font-size:17px;font-weight:700;cursor:pointer;margin-top:8px}

        /* ========== WEEK ========== */
        .wCal{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin:15px 0}
        .wDay{text-align:center;padding:10px 4px;border-radius:var(--r3);background:var(--card);border:1px solid var(--brd);transition:.3s}
        .wDay.today{border-color:var(--accent);background:rgba(16,185,129,0.1)}
        .wDay .dn{font-size:10px;color:var(--t3);font-weight:600}
        .wDay .dnum{font-size:16px;font-weight:700;margin:4px 0}
        .wDots{display:flex;justify-content:center;gap:3px;flex-wrap:wrap}
        .dot{width:6px;height:6px;border-radius:50%;background:var(--t3)}
        .dot.ok{background:var(--accent)}.dot.half{background:var(--gold)}

        .bars{display:flex;align-items:flex-end;justify-content:space-around;height:150px;padding:10px 0;margin:15px 0;border-bottom:1px solid var(--brd)}
        .barI{display:flex;flex-direction:column;align-items:center;gap:6px;flex:1}
        .bar{width:28px;border-radius:6px 6px 0 0;background:linear-gradient(to top,var(--accent),var(--accent2));transition:height 1s cubic-bezier(.4,0,.2,1);min-height:4px}
        .barL{font-size:10px;color:var(--t3);font-weight:600}

        .strC{background:var(--card);border:1px solid var(--brd);border-radius:var(--r2);padding:14px 16px;display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
        .strI{display:flex;align-items:center;gap:10px}
        .strI .se{font-size:24px}.strI .sn{font-size:14px;font-weight:600}
        .strV{display:flex;align-items:center;gap:6px;font-size:18px;font-weight:800;color:var(--gold)}

        .setG{background:var(--card);border:1px solid var(--brd);border-radius:var(--r);overflow:hidden;margin-bottom:16px}
        .setI{display:flex;align-items:center;justify-content:space-between;padding:16px 18px;border-bottom:1px solid var(--brd);cursor:pointer;transition:.3s}
        .setI:last-child{border-bottom:none}
        .setI:active{background:rgba(255,255,255,0.03)}
        .setL{display:flex;align-items:center;gap:12px}
        .setL .si{font-size:22px}.setL .st{font-size:15px;font-weight:500}
        .setV{font-size:13px;color:var(--t2)}

        .tog{position:relative;width:48px;height:26px}
        .tog input{display:none}
        .togS{position:absolute;inset:0;background:var(--t3);border-radius:26px;cursor:pointer;transition:.3s}
        .togS::before{content:'';position:absolute;width:20px;height:20px;border-radius:50%;background:white;top:3px;right:3px;transition:.3s}
        .tog input:checked+.togS{background:var(--accent)}
        .tog input:checked+.togS::before{transform:translateX(-22px)}

        .danger{width:100%;padding:14px;background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);border-radius:var(--r2);color:var(--red);font-family:var(--font);font-size:15px;font-weight:700;cursor:pointer;transition:.3s}
        .danger:active{background:rgba(239,68,68,0.2)}

        .nav{
            position:fixed;bottom:0;left:0;right:0;height:var(--navH);
            background:rgba(15,23,42,0.95);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);
            border-top:1px solid var(--brd);display:flex;align-items:center;
            justify-content:space-around;z-index:100;padding-bottom:env(safe-area-inset-bottom,0);
        }
        .navI{display:flex;flex-direction:column;align-items:center;gap:4px;padding:8px 16px;cursor:pointer;transition:.3s;border-radius:var(--r3);position:relative;-webkit-tap-highlight-color:transparent}
        .navI .ni{font-size:22px;transition:.3s}
        .navI .nl{font-size:10px;font-weight:600;color:var(--t3);transition:.3s}
        .navI.on .ni{transform:scale(1.15)}
        .navI.on .nl{color:var(--accent);font-weight:700}
        .navI.on::before{content:'';position:absolute;top:-1px;left:50%;transform:translateX(-50%);width:30px;height:3px;background:var(--accent);border-radius:0 0 4px 4px}

        .toast{position:fixed;top:calc(var(--headH)+10px);left:50%;transform:translateX(-50%) translateY(-100px);background:var(--bg2);border:1px solid var(--accent);color:var(--t1);padding:14px 24px;border-radius:var(--r2);font-family:var(--font);font-size:14px;font-weight:600;z-index:250;transition:transform .4s cubic-bezier(.4,0,.2,1);box-shadow:0 8px 32px rgba(0,0,0,0.4);white-space:nowrap}
        .toast.show{transform:translateX(-50%) translateY(0)}

        .confB{position:fixed;inset:0;pointer-events:none;z-index:300;overflow:hidden}
        .conf{position:absolute;width:10px;height:10px;top:-10px;animation:cF 3s linear forwards}
        @keyframes cF{0%{top:-10px;opacity:1;transform:rotate(0)}100%{top:110vh;opacity:0;transform:rotate(720deg)}}

        .instB{background:linear-gradient(135deg,rgba(16,185,129,0.2),rgba(245,158,11,0.15));border:1px solid rgba(16,185,129,0.3);border-radius:var(--r2);padding:14px 16px;align-items:center;justify-content:space-between;margin-bottom:12px;display:none}
        .instB.show{display:flex}
        .instT{font-size:13px;font-weight:600}
        .instBtn{padding:8px 16px;background:var(--accent);border:none;border-radius:20px;color:white;font-family:var(--font);font-size:12px;font-weight:700;cursor:pointer;white-space:nowrap}
        .instX{background:none;border:none;color:var(--t3);font-size:18px;cursor:pointer;padding:0 4px;margin-right:8px}

        @media(min-width:500px){
            .content{max-width:500px;margin:0 auto}
            .nav{max-width:500px;left:50%;transform:translateX(-50%);border-radius:var(--r) var(--r) 0 0}
        }
    </style>
</head>
<body>

<header class="header">
    <div class="header-r"><span class="logo">ğŸŒ™</span><h1>Ø¹Ø§Ø¯Ø§ØªÙŠ</h1></div>
    <span class="header-date" id="hDate"></span>
</header>

<div class="toast" id="toast"></div>

<main class="content">
    <!-- HOME -->
    <div class="page active" id="p-home">
        <div class="instB" id="instBan">
            <div style="display:flex;align-items:center;gap:8px">
                <button class="instX" onclick="document.getElementById('instBan').classList.remove('show')">âœ•</button>
                <span class="instT">ğŸ“² Ø­Ù…Ù‘Ù„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ</span>
            </div>
            <button class="instBtn" onclick="installApp()">ØªØ­Ù…ÙŠÙ„</button>
        </div>
        <div class="greeting">
            <p class="greeting-t" id="greetT"></p>
            <p class="greeting-s">ÙƒÙŠÙ ÙŠÙˆÙ…ÙƒØŸ ğŸ’«</p>
        </div>
        <div class="prog-w">
            <div class="prog-r">
                <svg viewBox="0 0 200 200">
                    <defs><linearGradient id="g1" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:#10b981"/><stop offset="100%" style="stop-color:#f59e0b"/></linearGradient></defs>
                    <circle class="bgC" cx="100" cy="100" r="85"/>
                    <circle class="fgC" id="progC" cx="100" cy="100" r="85" stroke-dasharray="534" stroke-dashoffset="534"/>
                </svg>
                <div class="prog-c"><div class="prog-p" id="progP">0%</div><div class="prog-l">Ø¥Ù†Ø¬Ø§Ø² Ø§Ù„ÙŠÙˆÙ…</div></div>
            </div>
        </div>
        <div class="stats">
            <div class="stat"><div class="stat-i">ğŸ”¥</div><div class="stat-v" id="sB">0</div><div class="stat-l">Ø£ÙØ¶Ù„ Ø³Ù„Ø³Ù„Ø©</div></div>
            <div class="stat"><div class="stat-i">âœ…</div><div class="stat-v" id="sD">0</div><div class="stat-l">Ù…ÙƒØªÙ…Ù„ Ø§Ù„ÙŠÙˆÙ…</div></div>
            <div class="stat"><div class="stat-i">ğŸ¯</div><div class="stat-v" id="sA">0</div><div class="stat-l">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù‡Ø§Ù…</div></div>
        </div>
        <div class="quote"><p class="quote-t" id="qT"></p><p class="quote-s" id="qS"></p></div>
        <h3 class="sec">âš¡ Ù†Ø¸Ø±Ø© Ø³Ø±ÙŠØ¹Ø©</h3>
        <div id="qH" class="hlist"></div>
    </div>

    <!-- HABITS -->
    <div class="page" id="p-habits">
        <h2 class="sec" style="font-size:22px;margin-top:5px">ğŸ“‹ Ø¹Ø§Ø¯Ø§ØªÙŠ</h2>
        <div id="hC" class="hlist"></div>
    </div>

    <!-- STATS -->
    <div class="page" id="p-stats">
        <h2 class="sec" style="font-size:22px;margin-top:5px">ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</h2>
        <h3 class="sec">ğŸ“… Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</h3>
        <div class="wCal" id="wCal"></div>
        <h3 class="sec">ğŸ“ˆ Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ</h3>
        <div class="bars" id="bChart"></div>
        <h3 class="sec">ğŸ”¥ Ø§Ù„Ø³Ù„Ø§Ø³Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠØ©</h3>
        <div id="strL"></div>
    </div>

    <!-- SETTINGS -->
    <div class="page" id="p-settings">
        <h2 class="sec" style="font-size:22px;margin-top:5px">âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h2>
        <div class="setG">
            <div class="setI" onclick="togNotif()"><div class="setL"><span class="si">ğŸ””</span><span class="st">Ø§Ù„ØªØ°ÙƒÙŠØ±Ø§Øª</span></div><label class="tog"><input type="checkbox" id="nTog"><span class="togS"></span></label></div>
            <div class="setI" onclick="exportD()"><div class="setL"><span class="si">ğŸ“¤</span><span class="st">ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</span></div><span class="setV">JSON</span></div>
            <div class="setI" onclick="document.getElementById('impF').click()"><div class="setL"><span class="si">ğŸ“¥</span><span class="st">Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</span></div><span class="setV">JSON</span></div>
        </div>
        <div class="setG">
            <div class="setI"><div class="setL"><span class="si">ğŸ“±</span><span class="st">Ø§Ù„Ø¥ØµØ¯Ø§Ø±</span></div><span class="setV">1.0.0</span></div>
            <div class="setI"><div class="setL"><span class="si">ğŸ’š</span><span class="st">ØµÙ†Ø¹ Ø¨Ø­Ø¨</span></div><span class="setV">ğŸŒ™</span></div>
        </div>
        <button class="danger" onclick="resetAll()" style="margin-top:10px">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
        <input type="file" id="impF" accept=".json" style="display:none" onchange="importD(event)">
    </div>
</main>

<!-- FAB - Add New Habit Button (ALWAYS VISIBLE) -->
<button class="fab" id="fabBtn" onclick="openModal()">+</button>

<!-- ADD MODAL -->
<div class="modal-bg" id="modal">
    <div class="modal">
        <div class="modal-h"></div>
        <h2 class="modal-t">âœ¨ Ø¥Ø¶Ø§ÙØ© Ø¹Ø§Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø©</h2>
        <div class="fg">
            <label class="fl">ğŸ’¡ Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª Ø³Ø±ÙŠØ¹Ø©</label>
            <div class="sgG">
                <button class="sgB" onclick="sug('ğŸ“–','Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù‚Ø±Ø¢Ù†','#3b82f6')"><span class="se">ğŸ“–</span>Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù‚Ø±Ø¢Ù†</button>
                <button class="sgB" onclick="sug('ğŸ¤²','Ø£Ø°ÙƒØ§Ø± Ø§Ù„ØµØ¨Ø§Ø­ ÙˆØ§Ù„Ù…Ø³Ø§Ø¡','#8b5cf6')"><span class="se">ğŸ¤²</span>Ø§Ù„Ø£Ø°ÙƒØ§Ø±</button>
                <button class="sgB" onclick="sug('ğŸƒ','Ø§Ù„Ø±ÙŠØ§Ø¶Ø©','#ef4444')"><span class="se">ğŸƒ</span>Ø§Ù„Ø±ÙŠØ§Ø¶Ø©</button>
                <button class="sgB" onclick="sug('ğŸ’§','Ø´Ø±Ø¨ Ø§Ù„Ù…Ø§Ø¡','#06b6d4')"><span class="se">ğŸ’§</span>Ø´Ø±Ø¨ Ø§Ù„Ù…Ø§Ø¡</button>
                <button class="sgB" onclick="sug('ğŸ“š','Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©','#f59e0b')"><span class="se">ğŸ“š</span>Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©</button>
                <button class="sgB" onclick="sug('ğŸ˜´','Ø§Ù„Ù†ÙˆÙ… Ø§Ù„Ù…Ø¨ÙƒØ±','#6366f1')"><span class="se">ğŸ˜´</span>Ø§Ù„Ù†ÙˆÙ… Ø§Ù„Ù…Ø¨ÙƒØ±</button>
                <button class="sgB" onclick="sug('ğŸ™','ØµÙ„Ø§Ø© Ø§Ù„Ø³Ù†Ù†','#14b8a6')"><span class="se">ğŸ™</span>ØµÙ„Ø§Ø© Ø§Ù„Ø³Ù†Ù†</button>
                <button class="sgB" onclick="sug('ğŸ’°','Ø§Ù„ØµØ¯Ù‚Ø©','#f97316')"><span class="se">ğŸ’°</span>Ø§Ù„ØµØ¯Ù‚Ø©</button>
            </div>
        </div>
        <div class="fg"><label class="fl">ğŸ“ Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ø¯Ø©</label><input type="text" class="fi" id="hNI" placeholder="Ù…Ø«Ø§Ù„: Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù‚Ø±Ø¢Ù†" maxlength="30"></div>
        <div class="fg"><label class="fl">ğŸ˜Š Ø§Ø®ØªØ± Ø£ÙŠÙ‚ÙˆÙ†Ø©</label><div class="emG" id="eG"></div></div>
        <div class="fg"><label class="fl">ğŸ¨ Ø§Ø®ØªØ± Ù„ÙˆÙ†</label><div class="coG" id="cG"></div></div>
        <button class="btnM" onclick="addH()">â• Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ø§Ø¯Ø©</button>
        <button class="btnC" onclick="closeModal()">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
</div>

<div class="confB" id="confB"></div>

<nav class="nav">
    <div class="navI on" onclick="go('home',this)"><span class="ni">ğŸ </span><span class="nl">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span></div>
    <div class="navI" onclick="go('habits',this)"><span class="ni">âœ…</span><span class="nl">Ø§Ù„Ø¹Ø§Ø¯Ø§Øª</span></div>
    <div class="navI" onclick="go('stats',this)"><span class="ni">ğŸ“Š</span><span class="nl">Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</span></div>
    <div class="navI" onclick="go('settings',this)"><span class="ni">âš™ï¸</span><span class="nl">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</span></div>
</nav>

<script>
// ============================================
// CONSTANTS
// ============================================
const SK='habitData_v2';
const SD=['Ø£Ø­Ø¯','Ø¥Ø«Ù†','Ø«Ù„Ø§','Ø£Ø±Ø¨','Ø®Ù…ÙŠ','Ø¬Ù…Ø¹','Ø³Ø¨Øª'];
const EM=['ğŸ“–','ğŸ¤²','ğŸƒ','ğŸ’§','ğŸ“š','ğŸ˜´','ğŸ™','ğŸ’°','ğŸ¯','ğŸ’ª','ğŸ§˜','ğŸ¥—','âœï¸','ğŸŒ…','ğŸŒ™','ğŸ•Œ','â­','ğŸ’'];
const CO=['#10b981','#3b82f6','#f59e0b','#ef4444','#8b5cf6','#ec4899','#06b6d4','#f97316','#14b8a6','#6366f1'];
const QU=[
    {t:'Ø¥ÙÙ†ÙÙ‘ Ù…ÙØ¹Ù Ø§Ù„Ù’Ø¹ÙØ³Ù’Ø±Ù ÙŠÙØ³Ù’Ø±Ù‹Ø§',s:'Ø³ÙˆØ±Ø© Ø§Ù„Ø´Ø±Ø­'},
    {t:'ÙˆÙÙ…ÙÙ† ÙŠÙØªÙÙ‘Ù‚Ù Ø§Ù„Ù„ÙÙ‘Ù‡Ù ÙŠÙØ¬Ù’Ø¹ÙÙ„ Ù„ÙÙ‘Ù‡Ù Ù…ÙØ®Ù’Ø±ÙØ¬Ù‹Ø§',s:'Ø³ÙˆØ±Ø© Ø§Ù„Ø·Ù„Ø§Ù‚'},
    {t:'ÙÙØ§Ø°Ù’ÙƒÙØ±ÙÙˆÙ†ÙÙŠ Ø£ÙØ°Ù’ÙƒÙØ±Ù’ÙƒÙÙ…Ù’',s:'Ø³ÙˆØ±Ø© Ø§Ù„Ø¨Ù‚Ø±Ø©'},
    {t:'ÙˆÙÙ‚ÙÙ„ Ø±ÙÙ‘Ø¨ÙÙ‘ Ø²ÙØ¯Ù’Ù†ÙÙŠ Ø¹ÙÙ„Ù’Ù…Ù‹Ø§',s:'Ø³ÙˆØ±Ø© Ø·Ù‡'},
    {t:'Ø£ÙÙ„ÙØ§ Ø¨ÙØ°ÙÙƒÙ’Ø±Ù Ø§Ù„Ù„ÙÙ‘Ù‡Ù ØªÙØ·Ù’Ù…ÙØ¦ÙÙ†ÙÙ‘ Ø§Ù„Ù’Ù‚ÙÙ„ÙÙˆØ¨Ù',s:'Ø³ÙˆØ±Ø© Ø§Ù„Ø±Ø¹Ø¯'},
    {t:'ÙˆÙÙ„ÙØ§ ØªÙÙŠÙ’Ø£ÙØ³ÙÙˆØ§ Ù…ÙÙ† Ø±ÙÙ‘ÙˆÙ’Ø­Ù Ø§Ù„Ù„ÙÙ‘Ù‡Ù',s:'Ø³ÙˆØ±Ø© ÙŠÙˆØ³Ù'},
    {t:'Ø£Ø­Ø¨ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ù„Ù‡ Ø£Ø¯ÙˆÙ…Ù‡Ø§ ÙˆØ¥Ù† Ù‚Ù„',s:'Ø­Ø¯ÙŠØ« Ù†Ø¨ÙˆÙŠ Ø´Ø±ÙŠÙ'},
    {t:'Ø®ÙŠØ±ÙƒÙ… Ù…Ù† ØªØ¹Ù„Ù… Ø§Ù„Ù‚Ø±Ø¢Ù† ÙˆØ¹Ù„Ù…Ù‡',s:'Ø­Ø¯ÙŠØ« Ù†Ø¨ÙˆÙŠ Ø´Ø±ÙŠÙ'},
    {t:'Ø¥Ù†Ù…Ø§ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø¨Ø§Ù„Ù†ÙŠØ§Øª',s:'Ø­Ø¯ÙŠØ« Ù†Ø¨ÙˆÙŠ Ø´Ø±ÙŠÙ'},
    {t:'Ø±ÙØ¨ÙÙ‘Ù†ÙØ§ Ø¢ØªÙÙ†ÙØ§ ÙÙÙŠ Ø§Ù„Ø¯ÙÙ‘Ù†Ù’ÙŠÙØ§ Ø­ÙØ³ÙÙ†ÙØ©Ù‹ ÙˆÙÙÙÙŠ Ø§Ù„Ù’Ø¢Ø®ÙØ±ÙØ©Ù Ø­ÙØ³ÙÙ†ÙØ©Ù‹',s:'Ø³ÙˆØ±Ø© Ø§Ù„Ø¨Ù‚Ø±Ø©'},
];
const DH=[
    {id:'prayer',name:'Ø§Ù„ØµÙ„ÙˆØ§Øª Ø§Ù„Ù…ÙØ±ÙˆØ¶Ø©',emoji:'ğŸ•Œ',color:'#10b981',type:'multi',
     subItems:[{id:'fajr',name:'Ø§Ù„ÙØ¬Ø±'},{id:'dhuhr',name:'Ø§Ù„Ø¸Ù‡Ø±'},{id:'asr',name:'Ø§Ù„Ø¹ØµØ±'},{id:'maghrib',name:'Ø§Ù„Ù…ØºØ±Ø¨'},{id:'isha',name:'Ø§Ù„Ø¹Ø´Ø§Ø¡'}],
     deletable:false},
    {id:'avoid-haram',name:'Ø§Ù„Ø§Ø¨ØªØ¹Ø§Ø¯ Ø¹Ù† Ø§Ù„Ø­Ø±Ø§Ù…',emoji:'ğŸ›¡ï¸',color:'#f59e0b',type:'boolean',deletable:false}
];

let D={habits:[],history:{},settings:{notifications:false}};
let sE='ğŸ“–',sC='#10b981',dP=null;

// ============================================
// INIT
// ============================================
document.addEventListener('DOMContentLoaded',()=>{
    load();
    initUI();
    regSW();
    // Make sure FAB is visible
    document.getElementById('fabBtn').style.display='flex';
});

function load(){
    const s=localStorage.getItem(SK);
    if(s){try{D=JSON.parse(s);DH.forEach(d=>{if(!D.habits.find(h=>h.id===d.id))D.habits.unshift(d)});}catch(e){D.habits=[...DH];D.history={};}}
    else{D.habits=[...DH];D.history={};}
    if(!D.settings)D.settings={notifications:false};save();
}
function save(){localStorage.setItem(SK,JSON.stringify(D))}

function initUI(){
    const now=new Date();
    document.getElementById('hDate').textContent=now.toLocaleDateString('ar-EG',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
    const h=now.getHours();
    document.getElementById('greetT').textContent=h<5?'Ù„ÙŠÙ„Ø© Ø³Ø¹ÙŠØ¯Ø© ğŸŒ™':h<12?'ØµØ¨Ø§Ø­ Ø§Ù„Ø®ÙŠØ± â˜€ï¸':h<17?'Ù…Ø³Ø§Ø¡ Ø§Ù„Ø®ÙŠØ± ğŸŒ¤ï¸':'Ù…Ø³Ø§Ø¡ Ø§Ù„Ù†ÙˆØ± ğŸŒ™';
    const dy=Math.floor((now-new Date(now.getFullYear(),0,0))/(864e5));
    const q=QU[dy%QU.length];
    document.getElementById('qT').textContent='ï´¿ '+q.t+' ï´¾';
    document.getElementById('qS').textContent='â€” '+q.s;
    bldE();bldC();renderAll();
    document.getElementById('nTog').checked=D.settings.notifications;
}

// ============================================
// DATE
// ============================================
function td(){return fmt(new Date())}
function fmt(d){return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0')}

// ============================================
// RENDER
// ============================================
function renderAll(){rHome();rHabits();rStats()}

function rHome(){
    const t=td(),dd=D.history[t]||{};
    let tot=0,don=0;
    D.habits.forEach(h=>{
        if(h.type==='multi'){tot+=h.subItems.length;const s=dd[h.id]||{};don+=h.subItems.filter(x=>s[x.id]).length;}
        else{tot++;if(dd[h.id])don++;}
    });
    const pct=tot?Math.round(don/tot*100):0;
    const circ=2*Math.PI*85;
    document.getElementById('progC').style.strokeDashoffset=circ-(pct/100)*circ;
    document.getElementById('progP').textContent=pct+'%';
    document.getElementById('sD').textContent=don;
    document.getElementById('sA').textContent=tot;
    document.getElementById('sB').textContent=bStr();
    const qc=document.getElementById('qH');qc.innerHTML='';
    D.habits.forEach(h=>{
        let c=0,t2=0,pt='';
        if(h.type==='multi'){t2=h.subItems.length;const s=dd[h.id]||{};c=h.subItems.filter(x=>s[x.id]).length;pt=c+'/'+t2;}
        else{t2=1;c=dd[h.id]?1:0;pt=c?'âœ“':'â€”';}
        const p=t2?Math.round(c/t2*100):0;
        const bg=p===100?h.color:'rgba(255,255,255,0.08)';
        const tc=p===100?'#fff':'var(--t2)';
        qc.innerHTML+='<div class="hcard" style="padding:14px 16px;cursor:pointer" onclick="go(\'habits\',document.querySelectorAll(\'.navI\')[1])"><div style="display:flex;align-items:center;justify-content:space-between"><div style="display:flex;align-items:center;gap:10px"><span style="font-size:24px">'+h.emoji+'</span><span style="font-size:14px;font-weight:600">'+h.name+'</span></div><span class="hbadge" style="background:'+bg+';color:'+tc+';border:1px solid '+h.color+'30">'+pt+'</span></div></div>';
    });
}

function rHabits(){
    const c=document.getElementById('hC'),t=td(),dd=D.history[t]||{};c.innerHTML='';
    D.habits.forEach(h=>{
        const str=cStr(h.id);
        const dl=h.deletable!==false?'<button class="del" onclick="delH(\''+h.id+'\',event)">ğŸ—‘ï¸</button>':'';
        if(h.type==='multi'){
            const sub=dd[h.id]||{},comp=h.subItems.filter(s=>sub[s.id]).length,tot=h.subItems.length;
            const p=Math.round(comp/tot*100),bg=p===100?h.color:'rgba(255,255,255,0.08)',tc=p===100?'#fff':'var(--t2)';
            let si='';h.subItems.forEach(s=>{
                si+='<div class="sub"><span class="sub-n">'+s.name+'</span><label class="chk"><input type="checkbox" '+(sub[s.id]?'checked':'')+' onchange="togS(\''+h.id+'\',\''+s.id+'\',this.checked)"><span class="chk-m" style="'+(sub[s.id]?'background:'+h.color+';border-color:'+h.color:'')+'"></span></label></div>';
            });
            c.innerHTML+='<div class="hcard"><div class="hbar" style="background:'+h.color+'"></div><div class="hhead"><div class="hinfo"><div class="hemoji" style="background:'+h.color+'20">'+h.emoji+'</div><div><div class="hname">'+h.name+'</div><div class="hstreak">'+(str>0?'<span class="fire">ğŸ”¥</span> '+str+' ÙŠÙˆÙ…':'Ø§Ø¨Ø¯Ø£ Ø³Ù„Ø³Ù„ØªÙƒ!')+'</div></div></div><div class="hacts">'+dl+'<span class="hbadge" style="background:'+bg+';color:'+tc+';border:1px solid '+h.color+'30">'+comp+'/'+tot+'</span></div></div><div class="hsubs">'+si+'</div></div>';
        }else{
            const dn=dd[h.id]||false;
            c.innerHTML+='<div class="hcard"><div class="hbar" style="background:'+h.color+'"></div><div class="hhead"><div class="hinfo"><div class="hemoji" style="background:'+h.color+'20">'+h.emoji+'</div><div><div class="hname">'+h.name+'</div><div class="hstreak">'+(str>0?'<span class="fire">ğŸ”¥</span> '+str+' ÙŠÙˆÙ…':'Ø§Ø¨Ø¯Ø£ Ø³Ù„Ø³Ù„ØªÙƒ!')+'</div></div></div><div class="hacts">'+dl+'</div></div><button class="htog '+(dn?'done':'')+'" onclick="togB(\''+h.id+'\')" style="'+(dn?'border-color:'+h.color+';color:'+h.color+';background:'+h.color+'15':'')+'">'+(dn?'âœ… ØªÙ… Ø¨Ø­Ù…Ø¯ Ø§Ù„Ù„Ù‡':'â¬œ Ø§Ø¶ØºØ· Ù„Ù„ØªØ£ÙƒÙŠØ¯')+'</button></div>';
        }
    });
}

function rStats(){
    const wc=document.getElementById('wCal');wc.innerHTML='';
    const t=new Date(),sw=new Date(t);sw.setDate(t.getDate()-t.getDay());
    for(let i=0;i<7;i++){
        const d=new Date(sw);d.setDate(sw.getDate()+i);const ds=fmt(d),isT=ds===td(),dd=D.history[ds]||{};
        let dots='';D.habits.forEach(h=>{const c=hComp(h,dd);dots+='<div class="dot '+(c>=1?'ok':c>0?'half':'')+'"></div>';});
        wc.innerHTML+='<div class="wDay '+(isT?'today':'')+'"><div class="dn">'+SD[i]+'</div><div class="dnum">'+d.getDate()+'</div><div class="wDots">'+dots+'</div></div>';
    }
    const bc=document.getElementById('bChart');bc.innerHTML='';
    for(let i=6;i>=0;i--){
        const d=new Date(t);d.setDate(t.getDate()-i);const ds=fmt(d),p=dTot(ds),ht=Math.max(4,p*130/100);
        bc.innerHTML+='<div class="barI"><div class="bar" style="height:'+ht+'px;'+(p===100?'background:linear-gradient(to top,#f59e0b,#fbbf24)':'')+'"></div><span class="barL">'+SD[d.getDay()]+'</span></div>';
    }
    const sl=document.getElementById('strL');sl.innerHTML='';
    D.habits.forEach(h=>{const s=cStr(h.id);
        sl.innerHTML+='<div class="strC"><div class="strI"><span class="se">'+h.emoji+'</span><span class="sn">'+h.name+'</span></div><div class="strV">'+(s>0?'ğŸ”¥':'ğŸ’¤')+'<span>'+s+'</span></div></div>';
    });
}

// ============================================
// DATA LOGIC
// ============================================
function togS(hid,sid,v){const t=td();if(!D.history[t])D.history[t]={};if(!D.history[t][hid])D.history[t][hid]={};D.history[t][hid][sid]=v;save();renderAll();vib(30);chkD()}
function togB(hid){const t=td();if(!D.history[t])D.history[t]={};D.history[t][hid]=!D.history[t][hid];save();renderAll();vib(30);chkD()}
function hComp(h,dd){if(h.type==='multi'){const s=dd[h.id]||{},c=h.subItems.filter(x=>s[x.id]).length;return h.subItems.length?c/h.subItems.length:0;}return dd[h.id]?1:0;}
function dTot(ds){const dd=D.history[ds]||{};let t=0,c=0;D.habits.forEach(h=>{if(h.type==='multi'){t+=h.subItems.length;const s=dd[h.id]||{};c+=h.subItems.filter(x=>s[x.id]).length;}else{t++;if(dd[h.id])c++;}});return t?Math.round(c/t*100):0;}
function cStr(hid){let s=0;const h=D.habits.find(x=>x.id===hid);if(!h)return 0;const d=new Date();let f=true;
    while(true){const ds=fmt(d),dd=D.history[ds]||{};if(hComp(h,dd)>=1){s++;d.setDate(d.getDate()-1);f=false;}else{if(f&&ds===td()){d.setDate(d.getDate()-1);f=false;continue;}break;}}return s;}
function bStr(){let b=0;D.habits.forEach(h=>{const s=cStr(h.id);if(s>b)b=s;});return b;}
function chkD(){if(dTot(td())===100){confetti();showT('ğŸ‰ Ù…Ø§ Ø´Ø§Ø¡ Ø§Ù„Ù„Ù‡! Ø£ÙƒÙ…Ù„Øª Ø¬Ù…ÙŠØ¹ Ø¹Ø§Ø¯Ø§ØªÙƒ Ø§Ù„ÙŠÙˆÙ…');}}

// ============================================
// HABIT MANAGEMENT
// ============================================
function addH(){
    const n=document.getElementById('hNI').value.trim();
    if(!n)return showT('âš ï¸ Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ø¯Ø©');
    if(D.habits.find(h=>h.name===n))return showT('âš ï¸ Ø§Ù„Ø¹Ø§Ø¯Ø© Ù…ÙˆØ¬ÙˆØ¯Ø©');
    D.habits.push({id:'h_'+Date.now(),name:n,emoji:sE,color:sC,type:'boolean',deletable:true});
    save();renderAll();closeModal();showT('âœ… ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¬Ø§Ø­');vib(50);
}
function delH(id,e){e.stopPropagation();if(confirm('Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ø§Ø¯Ø©ØŸ')){D.habits=D.habits.filter(h=>h.id!==id);Object.keys(D.history).forEach(d=>{delete D.history[d][id]});save();renderAll();showT('ğŸ—‘ï¸ ØªÙ… Ø§Ù„Ø­Ø°Ù');}}
function sug(e,n,c){document.getElementById('hNI').value=n;sE=e;sC=c;
    document.querySelectorAll('.emO').forEach(el=>el.classList.toggle('sel',el.textContent.trim()===e));
    document.querySelectorAll('.coO').forEach(el=>el.classList.toggle('sel',el.dataset.c===c));vib(20);}

// ============================================
// MODAL
// ============================================
function openModal(){document.getElementById('modal').classList.add('open');document.getElementById('hNI').value='';sE='ğŸ“–';sC='#10b981';bldE();bldC();}
function closeModal(){document.getElementById('modal').classList.remove('open')}
function bldE(){const g=document.getElementById('eG');g.innerHTML='';EM.forEach(e=>{const d=document.createElement('div');d.className='emO'+(e===sE?' sel':'');d.textContent=e;d.onclick=()=>{sE=e;document.querySelectorAll('.emO').forEach(x=>x.classList.remove('sel'));d.classList.add('sel');vib(15)};g.appendChild(d)})}
function bldC(){const g=document.getElementById('cG');g.innerHTML='';CO.forEach(c=>{const d=document.createElement('div');d.className='coO'+(c===sC?' sel':'');d.style.background=c;d.dataset.c=c;d.onclick=()=>{sC=c;document.querySelectorAll('.coO').forEach(x=>x.classList.remove('sel'));d.classList.add('sel');vib(15)};g.appendChild(d)})}

// ============================================
// NAVIGATION
// ============================================
function go(p,ni){
    document.querySelectorAll('.page').forEach(x=>x.classList.remove('active'));
    document.getElementById('p-'+p).classList.add('active');
    document.querySelectorAll('.navI').forEach(x=>x.classList.remove('on'));
    if(ni)ni.classList.add('on');
    if(p==='stats')rStats();if(p==='home')rHome();vib(10);
}

// ============================================
// UI HELPERS
// ============================================
function showT(m){const t=document.getElementById('toast');t.textContent=m;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),3000)}
function vib(ms){if(navigator.vibrate)navigator.vibrate(ms)}
function confetti(){const c=document.getElementById('confB');c.innerHTML='';const cols=['#10b981','#f59e0b','#3b82f6','#ef4444','#8b5cf6','#ec4899','#fbbf24'];for(let i=0;i<50;i++){const p=document.createElement('div');p.className='conf';p.style.left=Math.random()*100+'%';p.style.animationDelay=Math.random()*2+'s';p.style.animationDuration=(Math.random()*2+2)+'s';p.style.background=cols[Math.floor(Math.random()*cols.length)];p.style.borderRadius=Math.random()>.5?'50%':'2px';p.style.width=(Math.random()*8+4)+'px';p.style.height=(Math.random()*8+4)+'px';c.appendChild(p);}setTimeout(()=>c.innerHTML='',5000);}

// ============================================
// SETTINGS
// ============================================
function togNotif(){const t=document.getElementById('nTog');t.checked=!t.checked;D.settings.notifications=t.checked;save();
    if(t.checked&&'Notification'in window){Notification.requestPermission().then(p=>{if(p!=='granted'){t.checked=false;D.settings.notifications=false;save();showT('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø³Ù…Ø§Ø­');}else showT('ğŸ”” ØªÙ… Ø§Ù„ØªÙØ¹ÙŠÙ„')});}else showT(t.checked?'ğŸ”” ØªÙ… Ø§Ù„ØªÙØ¹ÙŠÙ„':'ğŸ”• ØªÙ… Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù');}
function exportD(){const b=new Blob([JSON.stringify(D,null,2)],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='habits_'+td()+'.json';a.click();showT('ğŸ“¤ ØªÙ… Ø§Ù„ØªØµØ¯ÙŠØ±')}
function importD(e){const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=ev=>{try{const d=JSON.parse(ev.target.result);if(d.habits&&d.history){D=d;save();renderAll();showT('ğŸ“¥ ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯');}else showT('âš ï¸ Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­');}catch(x){showT('âš ï¸ Ø®Ø·Ø£')}};r.readAsText(f);e.target.value='';}
function resetAll(){if(confirm('âš ï¸ Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ')){if(confirm('ØªØ£ÙƒÙŠØ¯ Ø£Ø®ÙŠØ±ØŸ')){localStorage.removeItem(SK);D={habits:[...DH],history:{},settings:{notifications:false}};save();renderAll();showT('ğŸ—‘ï¸ ØªÙ… Ø§Ù„Ù…Ø³Ø­')}}}

// ============================================
// PWA
// ============================================
function regSW(){if('serviceWorker'in navigator)navigator.serviceWorker.register('sw.js').then(r=>console.log('SW:',r.scope)).catch(e=>console.log('SW fail:',e))}
window.addEventListener('beforeinstallprompt',e=>{e.preventDefault();dP=e;document.getElementById('instBan').classList.add('show')});
function installApp(){if(dP){dP.prompt();dP.userChoice.then(c=>{if(c.outcome==='accepted')showT('ğŸ‰ ØªÙ… Ø§Ù„ØªØ«Ø¨ÙŠØª!');dP=null;document.getElementById('instBan').classList.remove('show')})}}

// Close modal on overlay click
document.getElementById('modal').addEventListener('click',e=>{if(e.target===e.currentTarget)closeModal()});
</script>
</body>
</html>
